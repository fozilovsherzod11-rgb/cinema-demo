<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titan Cinema & Trade</title>
    <style>
        /* --- 1. –ë–ê–ó–ê (–¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #050505; /* –ü–æ—á—Ç–∏ —á–µ—Ä–Ω—ã–π */
            color: #e0e0e0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            height: 100vh; height: 100dvh; 
            display: flex; justify-content: center; overflow: hidden;
        }

        /* --- 2. –ì–õ–ê–í–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† --- */
        #app {
            width: 100%;
            max-width: 600px; /* –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ü–ö */
            height: 100%;
            background: #000;
            display: flex; flex-direction: column;
            position: relative;
            box-shadow: 0 0 50px rgba(0,255,0,0.1); /* –õ–µ–≥–∫–æ–µ –∑–µ–ª–µ–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ (–ö—Ä–∏–ø—Ç–∞) */
            border-left: 1px solid #111; border-right: 1px solid #111;
        }

        /* --- 3. –®–ê–ü–ö–ê + –ë–ò–¢–ö–û–ò–ù –¢–ò–ö–ï–† --- */
        header {
            padding: 8px 15px;
            background: #111;
            border-bottom: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; font-weight: 600;
        }
        
        /* –°—Ç–∏–ª—å –¢–∏–∫–µ—Ä–∞ –ë–∏—Ç–∫–æ–∏–Ω–∞ */
        .btc-ticker {
            font-family: 'Courier New', monospace; /* –®—Ä–∏—Ñ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ */
            font-size: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .btc-price { transition: color 0.3s; font-weight: bold; }
        .up { color: #00ff00; }   /* –ó–µ–ª–µ–Ω—ã–π */
        .down { color: #ff0055; } /* –ö—Ä–∞—Å–Ω—ã–π */
        .btc-icon { color: #f2a900; } /* –ó–æ–ª–æ—Ç–æ–π —Ü–≤–µ—Ç BTC */

        .live-badge { color: #e50914; display: flex; align-items: center; gap: 5px; font-size: 12px; }
        .live-dot { width: 6px; height: 6px; background: #e50914; border-radius: 50%; animation: pulse 2s infinite; }

        /* --- 4. –í–ò–î–ï–û --- */
        #video-wrapper {
            width: 100%; aspect-ratio: 16/9; background: #000;
            flex-shrink: 0; position: relative; z-index: 10;
        }
        #player { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }

        /* --- 5. –£–ü–†–ê–í–õ–ï–ù–ò–ï --- */
        #controls {
            padding: 10px; background: #0f0f0f; border-bottom: 1px solid #222;
            display: flex; flex-direction: column; gap: 8px; flex-shrink: 0;
        }
        .btn-group { display: flex; gap: 8px; }
        
        input {
            background: #1a1a1a; border: 1px solid #333; color: white;
            padding: 10px; border-radius: 6px; font-size: 14px; flex-grow: 1;
        }
        input:focus { border-color: #f2a900; } /* –§–æ–∫—É—Å –∂–µ–ª—Ç—ã–π –∫–∞–∫ BTC */
        
        button {
            padding: 0 15px; font-weight: 600; color: white; background: #333;
            border: none; border-radius: 6px; cursor: pointer; transition: 0.1s;
        }
        button.primary { background: #e50914; color: #fff; padding: 10px; width: 100%; }
        button.trade { background: #222; color: #00ff00; border: 1px solid #004400; width: auto; } /* –ö–Ω–æ–ø–∫–∞ Load */

        /* --- 6. –ß–ê–¢ --- */
        #chat-container {
            flex-grow: 1; display: flex; flex-direction: column;
            background: #050505; overflow: hidden; position: relative;
        }
        #messages {
            flex-grow: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
            scroll-behavior: smooth;
        }

        .msg { max-width: 85%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg-name { font-size: 10px; color: #666; margin-bottom: 2px; display: block; font-weight: bold; }
        
        .msg.mine { align-self: flex-end; background: #222; color: #fff; border: 1px solid #333; border-right: 3px solid #e50914; }
        .msg.mine .msg-name { text-align: right; color: #e50914; }
        
        .msg.theirs { align-self: flex-start; background: #111; color: #ccc; border: 1px solid #222; border-left: 3px solid #444; }
        
        .msg.system { align-self: center; background: transparent; color: #444; font-size: 11px; font-style: italic; }

        .input-bar {
            padding: 10px; background: #111; border-top: 1px solid #222;
            display: flex; gap: 10px; padding-bottom: env(safe-area-inset-bottom, 10px);
        }

        /* --- 7. –í–•–û–î --- */
        #login-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .login-box {
            background: #111; padding: 25px; border-radius: 12px; width: 85%; max-width: 320px;
            text-align: center; border: 1px solid #333; box-shadow: 0 0 30px rgba(242, 169, 0, 0.1);
        }
        .login-box h2 { margin-bottom: 15px; color: #fff; font-size: 18px; }

        /* –û–≥–æ–Ω—å */
        .fire-anim { position: absolute; bottom: 80px; right: 20px; font-size: 60px; opacity: 0; pointer-events: none; z-index: 100; transition: 0.5s; }
        .show { transform: translateY(-80px); opacity: 1; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <input type="text" id="usernameInput" placeholder="–ò–º—è (–¢—Ä–µ–π–¥–µ—Ä)..." autofocus>
            <button class="primary" style="margin-top: 15px; background: #f2a900; color: #000;" onclick="enterApp()">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="app">
        
        <header>
            <div class="btc-ticker">
                <span class="btc-icon">‚Çø</span>
                <span id="btc-price-display" class="btc-price">loading...</span>
            </div>
            <div class="live-badge"><div class="live-dot"></div> <span id="viewer-count">0 ON</span></div>
        </header>

        <div id="video-wrapper">
            <div id="player"></div>
        </div>

        <div id="controls">
            <button class="primary" onclick="sendReaction()">üî• –†–ï–°–ü–ï–ö–¢</button>
            <div class="btn-group">
                <input type="text" id="videoUrl" placeholder="–°—Å—ã–ª–∫–∞ (Shorts/Video)..." />
                <button class="trade" onclick="changeVideo()">‚ñ∂ LOAD</button>
            </div>
        </div>

        <div id="chat-container">
            <div id="messages">
                <div class="msg system">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
            <div class="input-bar">
                <input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button class="primary" style="width: auto;" onclick="sendMessage()">‚û§</button>
            </div>
            <div id="fire" class="fire-anim">üî•</div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let player;
        let isRemote = false;
        let lastPrice = 0;

        // --- 1. –õ–û–ì–ò–ö–ê BTC (Binance WebSocket) ---
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞–ø—Ä—è–º—É—é –∫ –±–∏—Ä–∂–µ, –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
        const priceElement = document.getElementById('btc-price-display');

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const price = parseFloat(data.p).toFixed(2); // –¶–µ–Ω–∞ —Å 2 –∑–Ω–∞–∫–∞–º–∏
            
            // –¶–≤–µ—Ç: –ó–µ–ª–µ–Ω—ã–π –µ—Å–ª–∏ –≤—ã—Ä–æ—Å–ª–∞, –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ —É–ø–∞–ª–∞
            if (price > lastPrice) {
                priceElement.className = 'btc-price up';
                priceElement.textContent = `${price} ‚ñ≤`;
            } else if (price < lastPrice) {
                priceElement.className = 'btc-price down';
                priceElement.textContent = `${price} ‚ñº`;
            }
            lastPrice = price;
        };

        // --- 2. –í–•–û–î ---
        function enterApp() {
            const name = document.getElementById('usernameInput').value.trim();
            if (name) {
                socket.emit('set_username', name);
                document.getElementById('login-overlay').style.display = 'none';
                initYouTube();
            } else { alert("–í–≤–µ–¥–∏ –∏–º—è!"); }
        }

        // --- 3. YOUTUBE ---
        function initYouTube() {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk',
                playerVars: { 'playsinline': 1, 'rel': 0, 'controls': 1, 'modestbranding': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (isRemote) return;
            const t = player.getCurrentTime();
            if (event.data == YT.PlayerState.PLAYING) socket.emit('sync_action', {type:'play', time:t});
            if (event.data == YT.PlayerState.PAUSED) socket.emit('sync_action', {type:'pause', time:t});
        }

        // --- 4. SOCKETS ---
        socket.on('update_viewers', (count) => {
            document.getElementById('viewer-count').textContent = `${count} ON`;
        });

        socket.on('sync_action', (data) => {
            isRemote = true;
            if (player && player.seekTo) {
                if (Math.abs(player.getCurrentTime() - data.time) > 1) player.seekTo(data.time);
                if (data.type === 'play') player.playVideo();
                if (data.type === 'pause') player.pauseVideo();
            }
            setTimeout(() => { isRemote = false; }, 500);
        });

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û (Shorts + Video) ---
        function changeVideo() {
            let val = document.getElementById('videoUrl').value.trim();
            if(!val) return;
            let vid = '';

            // –£–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Å—Å—ã–ª–æ–∫
            if (val.includes('shorts/')) vid = val.split('shorts/')[1].split('?')[0];
            else if (val.includes('v=')) vid = val.split('v=')[1].split('&')[0];
            else if (val.includes('youtu.be/')) vid = val.split('youtu.be/')[1].split('?')[0];
            else if (val.length === 11) vid = val;

            if(vid) { 
                socket.emit('change_video', vid); 
                document.getElementById('videoUrl').value = '';
            } else { alert("–°—Å—ã–ª–∫–∞ –∫—Ä–∏–≤–∞—è!"); }
        }
        socket.on('update_video', (id) => { if(player) player.loadVideoById(id); });

        // –†–µ–∞–∫—Ü–∏—è
        function sendReaction() { socket.emit('send_reaction'); }
        socket.on('show_reaction', () => {
            const el = document.getElementById('fire');
            el.classList.add('show');
            setTimeout(() => { el.classList.remove('show'); }, 1000);
        });

        // –ß–∞—Ç
        const chatIn = document.getElementById('chatInput');
        const list = document.getElementById('messages');

        function sendMessage() {
            const txt = chatIn.value.trim();
            if(txt) { socket.emit('chat_message', txt); chatIn.value = ''; chatIn.focus(); }
        }
        chatIn.addEventListener("keyup", (e) => { if(e.key === "Enter") sendMessage(); });

        socket.on('chat_message', (data) => {
            const div = document.createElement('div');
            if (data.type === 'system') {
                div.className = 'msg system'; div.textContent = data.text;
            } else {
                const isMine = (data.userId === socket.id);
                div.className = isMine ? 'msg mine' : 'msg theirs';
                div.innerHTML = `<span class="msg-name">${isMine ? '–Ø' : data.user}</span>${data.text}`;
            }
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        });
    </script>
</body>
</html>
