<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titan Room</title>
    <style>
        /* –ë–ê–ó–ê */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { 
            background: #000; color: #fff; font-family: sans-serif;
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* 1. –í–ò–î–ï–û (–°–≤–µ—Ä—Ö—É) */
        #video-area {
            width: 100%; aspect-ratio: 16/9; background: #000;
            flex-shrink: 0; position: relative; z-index: 10;
        }
        #player { width: 100%; height: 100%; position: absolute; }

        /* 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï (–ü–æ–ª–æ—Å–∫–∞) */
        #controls {
            padding: 8px; background: #111; border-bottom: 1px solid #333;
            display: flex; gap: 8px; flex-shrink: 0; z-index: 20;
        }
        input.dark { background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 6px; flex-grow: 1; }
        button { padding: 8px 15px; background: #333; color: #fff; border: none; border-radius: 6px; font-weight: bold; }
        button.red { background: #e50914; }

        /* 3. –°–ï–¢–ö–ê –£–ß–ê–°–¢–ù–ò–ö–û–í (–ì–ª–∞–≤–Ω–∞—è —Ñ–∏—à–∫–∞) */
        #user-grid {
            flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –º–µ—Å—Ç–æ —Å–Ω–∏–∑—É */
            background: #0a0a0a;
            padding: 5px;
            display: grid;
            gap: 5px;
            /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 2 –∫–æ–ª–æ–Ω–∫–∏, –∫–∞–∫ –Ω–∞ —Ä–∏—Å—É–Ω–∫–µ */
            grid-template-columns: 1fr 1fr; 
            grid-auto-rows: 1fr; /* –†—è–¥—ã —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç—Å—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ */
            overflow-y: auto;
        }

        /* –ö–ê–†–¢–û–ß–ö–ê –£–ß–ê–°–¢–ù–ò–ö–ê (–ü–ª–∏—Ç–∫–∞) */
        .user-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            position: relative;
            display: flex; flex-direction: column;
            justify-content: flex-end; /* –¢–µ–∫—Å—Ç —Å–Ω–∏–∑—É */
            overflow: hidden;
            transition: 0.3s;
            min-height: 120px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø–ª–∏—Ç–∫–∏ */
        }
        
        /* –ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–≤ —É–≥–ª—É) */
        .user-name-tag {
            position: absolute; top: 8px; left: 8px;
            background: rgba(0,0,0,0.6); padding: 4px 8px;
            border-radius: 4px; font-size: 12px; color: #ccc; font-weight: bold;
        }

        /* –ê–≤–∞—Ç–∞—Ä (–ö—Ä—É–≥ –≤ —Ü–µ–Ω—Ç—Ä–µ) */
        .user-avatar {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; opacity: 0.3;
        }

        /* –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ –ø–ª–∏—Ç–∫–∏ */
        .bubble-area {
            padding: 10px;
            display: flex; flex-direction: column; gap: 5px;
            max-height: 100%; overflow-y: hidden;
        }
        
        .bubble {
            background: #fff; color: #000;
            padding: 8px 12px; border-radius: 12px; border-bottom-left-radius: 2px;
            font-size: 14px; align-self: flex-start;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            word-wrap: break-word;
        }

        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* –í–í–û–î (–ü—Ä–∏–∫–ª–µ–µ–Ω –∫ –Ω–∏–∑—É) */
        #input-bar {
            padding: 10px; background: #111; border-top: 1px solid #333;
            display: flex; gap: 10px; flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }
        
        /* –í–•–û–î */
        #login-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box { text-align: center; width: 80%; max-width: 300px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-bottom: 20px;">–ö—Ç–æ —Ç—ã, –≤–æ–∏–Ω?</h2>
            <input type="text" id="nameIn" class="dark" placeholder="–¢–≤–æ–µ –∏–º—è..." style="width: 100%; font-size: 18px; margin-bottom: 15px;">
            <button class="red" style="width: 100%; padding: 15px;" onclick="joinRoom()">–í–û–ô–¢–ò –í –ö–û–ú–ù–ê–¢–£</button>
        </div>
    </div>

    <div id="video-area">
        <div id="player"></div>
    </div>

    <div id="controls">
        <button class="red" onclick="socket.emit('send_reaction')">üî•</button>
        <input type="text" id="vidUrl" class="dark" placeholder="–°—Å—ã–ª–∫–∞ YouTube...">
        <button onclick="changeVideo()">‚ñ∂</button>
    </div>

    <div id="user-grid">
        </div>

    <div id="input-bar">
        <input type="text" id="msgIn" class="dark" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å...">
        <button class="red" onclick="sendMsg()">‚û§</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let player, myId;
        
        // --- –õ–û–ì–ò–ö–ê –°–ï–¢–ö–ò ---
        socket.on('update_grid', (users) => {
            const grid = document.getElementById('user-grid');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –º–∏–≥–∞–ª–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Å–ª–æ–∂–Ω–µ–µ, —Ç—É—Ç —É–ø—Ä–æ—Å—Ç–∏–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É)
            // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –ø–æ–∑–∏—Ü–∏–π
            grid.innerHTML = '';

            // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞: 
            // 1 —á–µ–ª = 1 –∫–æ–ª–æ–Ω–∫–∞
            // 2-4 —á–µ–ª = 2 –∫–æ–ª–æ–Ω–∫–∏
            // 5-6 —á–µ–ª = 2 –∏–ª–∏ 3 –∫–æ–ª–æ–Ω–∫–∏
            let cols = (users.length === 1) ? 1 : 2;
            if (users.length > 4 && window.innerWidth > 600) cols = 3; // –ù–∞ –∫–æ–º–ø–µ 3 –∫–æ–ª–æ–Ω–∫–∏
            
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            users.forEach(u => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.id = `card-${u.id}`;
                card.style.borderColor = u.color;
                
                card.innerHTML = `
                    <div class="user-avatar" style="background:${u.color}">${u.name[0]}</div>
                    <div class="user-name-tag">${u.name}</div>
                    <div class="bubble-area" id="bubbles-${u.id}"></div>
                `;
                grid.appendChild(card);
            });
        });

        // --- –õ–û–ì–ò–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –í –ü–õ–ò–¢–ö–ê–• ---
        socket.on('chat_bubble', (data) => {
            const area = document.getElementById(`bubbles-${data.userId}`);
            if (area) {
                const b = document.createElement('div');
                b.className = 'bubble';
                b.textContent = data.text;
                area.appendChild(b);
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ, –µ—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ (–æ—Å—Ç–∞–≤–ª—è–µ–º 2 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
                while (area.children.length > 2) area.removeChild(area.firstChild);
            }
        });

        // --- –í–•–û–î –ò –Æ–¢–£–ë ---
        function joinRoom() {
            const name = document.getElementById('nameIn').value || "–ê–Ω–æ–Ω–∏–º";
            socket.emit('set_username', name);
            document.getElementById('login-overlay').style.display = 'none';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º YouTube
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.body.appendChild(tag);
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk',
                playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0 },
                events: { 'onStateChange': onStateChange }
            });
        }

        // --- –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function sendMsg() {
            const txt = document.getElementById('msgIn').value;
            if(txt) { socket.emit('chat_message', txt); document.getElementById('msgIn').value = ''; }
        }

        function changeVideo() {
            let val = document.getElementById('vidUrl').value;
            let vid = val.split('v=')[1] || val.split('youtu.be/')[1] || val;
            if(vid) { socket.emit('change_video', vid.split('&')[0]); }
        }
        
        socket.on('update_video', (id) => player && player.loadVideoById(id));
        socket.on('sync_action', (d) => { if(Math.abs(player.getCurrentTime()-d.time)>1) player.seekTo(d.time); d.type=='play'?player.playVideo():player.pauseVideo(); });
        
        function onStateChange(e) {
            if (e.data == 1) socket.emit('sync_action', {type:'play', time:player.getCurrentTime()});
            if (e.data == 2) socket.emit('sync_action', {type:'pause', time:player.getCurrentTime()});
        }
    </script>
</body>
</html>
