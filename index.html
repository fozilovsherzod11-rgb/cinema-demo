<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titan Cinema</title>
    <style>
        /* –°—Ç–∏–ª—å "–•–∞–∫–µ—Ä—Å–∫–∏–π Netflix" */
        body { margin: 0; background-color: #0d0d0d; color: #fff; font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–ª–µ–µ—Ä–∞ */
        #player-container { width: 100%; max-width: 900px; aspect-ratio: 16/9; background: #000; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e50914; }
        #player { width: 100%; height: 100%; }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .main-content { width: 90%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; margin-top: 15px; padding-bottom: 20px; flex-grow: 1; }

        /* –ö–Ω–æ–ø–∫–∏ –∏ –ò–Ω–ø—É—Ç—ã */
        .control-row { display: flex; gap: 10px; }
        input { background: #222; border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; flex-grow: 1; font-size: 16px; outline: none; }
        input:focus { border-color: #e50914; }
        
        .btn { padding: 12px 20px; font-size: 16px; font-weight: bold; color: white; background: #333; border: none; border-radius: 6px; cursor: pointer; text-transform: uppercase; }
        .btn-red { background: #e50914; width: 100%; }
        .btn:active { transform: scale(0.96); opacity: 0.8; }

        /* –ß–ê–¢ (–ù–æ–≤–∞—è —Ñ–∏—á–∞) */
        #chat-container { flex-grow: 1; background: #1a1a1a; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; max-height: 40vh; }
        #messages { flex-grow: 1; padding: 10px; overflow-y: auto; list-style: none; margin: 0; display: flex; flex-direction: column; gap: 8px; }
        #messages li { padding: 8px 12px; background: #2a2a2a; border-radius: 10px; font-size: 14px; max-width: 80%; align-self: flex-start; word-wrap: break-word; }
        #messages li.my-msg { background: #e50914; align-self: flex-end; }
        
        .chat-input-area { display: flex; padding: 10px; background: #222; border-top: 1px solid #333; }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–≥–Ω—è */
        .emoji-container { position: fixed; bottom: 20px; right: 20px; font-size: 80px; transition: transform 0.5s, opacity 0.5s; opacity: 0; pointer-events: none; z-index: 100; }
        .show-fire { transform: translateY(-100px); opacity: 1; }
    </style>
</head>
<body>

    <div id="player-container">
        <div id="player"></div>
    </div>

    <div class="main-content">
        <button class="btn btn-red" onclick="sendReaction()">üî• Send Respect</button>

        <div class="control-row">
            <input type="text" id="videoUrl" placeholder="–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É YouTube...">
            <button class="btn" onclick="requestVideoChange()">Load</button>
        </div>

        <div id="chat-container">
            <ul id="messages">
                </ul>
            <div class="chat-input-area">
                <input id="chatInput" autocomplete="off" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." />
                <button class="btn" onclick="sendMessage()" style="margin-left: 5px;">‚û§</button>
            </div>
        </div>
    </div>

    <div id="reaction" class="emoji-container">üî•</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let player;
        let isRemoteUpdate = false;

        // --- YOUTUBE API ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk', // –í–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                playerVars: { 'playsinline': 1, 'rel': 0, 'modestbranding': 1, 'controls': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (isRemoteUpdate) return;
            const time = player.getCurrentTime();
            if (event.data === YT.PlayerState.PLAYING) socket.emit('sync_action', { type: 'play', time: time });
            if (event.data === YT.PlayerState.PAUSED) socket.emit('sync_action', { type: 'pause', time: time });
        }

        // --- SOCKET LISTENERS ---
        
        // 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        socket.on('sync_action', (data) => {
            isRemoteUpdate = true;
            if (Math.abs(player.getCurrentTime() - data.time) > 1) player.seekTo(data.time);
            if (data.type === 'play') player.playVideo();
            if (data.type === 'pause') player.pauseVideo();
            setTimeout(() => { isRemoteUpdate = false; }, 500);
        });

        // 2. –†–µ–∞–∫—Ü–∏—è
        function sendReaction() { socket.emit('send_reaction'); }
        socket.on('show_reaction', () => {
            const el = document.getElementById('reaction');
            el.classList.add('show-fire');
            setTimeout(() => { el.classList.remove('show-fire'); }, 1000);
        });

        // 3. –°–º–µ–Ω–∞ –≤–∏–¥–µ–æ
        function requestVideoChange() {
            const url = document.getElementById('videoUrl').value;
            let videoId = '';
            // –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º ID –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å—Å—ã–ª–æ–∫
            if (url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
            else if (url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split('?')[0];

            if (videoId) {
                socket.emit('change_video', videoId);
                document.getElementById('videoUrl').value = '';
            }
        }
        socket.on('update_video', (videoId) => {
            if(player && videoId) player.loadVideoById(videoId);
        });

        // 4. –ß–∞—Ç
        const chatInput = document.getElementById('chatInput');
        
        function sendMessage() {
            if (chatInput.value) {
                socket.emit('chat_message', chatInput.value);
                chatInput.value = '';
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        chatInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") sendMessage();
        });

        socket.on('chat_message', (msg) => {
            const item = document.createElement('li');
            item.textContent = msg;
            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–µ (–ø—Ä–æ—Å—Ç–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω—ã ID, —Ç—É—Ç —É–ø—Ä–æ—Å—Ç–∏–º:
            // –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById('messages').appendChild(item);
            
            // –ê–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight; // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Å–∫—Ä–æ–ª–ª–∏–º —Å–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞, –∞ –Ω–µ —Å–ø–∏—Å–æ–∫
        });

    </script>
</body>
</html>
