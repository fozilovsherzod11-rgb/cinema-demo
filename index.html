<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Cinema</title>
    <style>
        body { margin: 0; background-color: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        /* –°—Ç–∏–ª—å –ø–ª–µ–µ—Ä–∞ */
        #player-container { width: 100%; max-width: 900px; aspect-ratio: 16/9; box-shadow: 0 0 40px rgba(229, 9, 20, 0.3); border: 1px solid #333; }
        #player { width: 100%; height: 100%; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .controls { margin-top: 30px; display: flex; gap: 20px; }
        .btn { padding: 12px 30px; font-size: 18px; font-weight: bold; color: white; background: #e50914; border: none; border-radius: 4px; cursor: pointer; transition: transform 0.1s; text-transform: uppercase; letter-spacing: 1px; }
        .btn:active { transform: scale(0.95); }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–≥–Ω—è */
        .emoji-container { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); font-size: 80px; transition: bottom 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.8s; opacity: 0; pointer-events: none; }
        .show-fire { bottom: 50%; opacity: 1; }
    </style>
</head>
<body>

    <div id="player-container">
        <div id="player"></div>
    </div>

    <div class="controls">
        <button class="btn" onclick="sendReaction()">üî• –†–µ—Å–ø–µ–∫—Ç</button>
    </div>

    <div id="reaction" class="emoji-container">üî•</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let player;
        let isRemoteUpdate = false; // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º YouTube API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk', // <-- ID –≤–∏–¥–µ–æ (Lofi Hip Hop)
                playerVars: { 'playsinline': 1, 'modestbranding': 1, 'rel': 0 },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // 2. –ö–æ–≥–¥–∞ –¢–´ –Ω–∞–∂–∏–º–∞–µ—à—å –∫–Ω–æ–ø–∫–∏
        function onPlayerStateChange(event) {
            if (isRemoteUpdate) return; // –ï—Å–ª–∏ —ç—Ç–æ —Å–µ—Ä–≤–µ—Ä –∫–æ–º–∞–Ω–¥—É–µ—Ç, –º–æ–ª—á–∏–º

            const time = player.getCurrentTime();
            if (event.data === YT.PlayerState.PLAYING) {
                socket.emit('sync_action', { type: 'play', time: time });
            } else if (event.data === YT.PlayerState.PAUSED) {
                socket.emit('sync_action', { type: 'pause', time: time });
            }
        }

        // 3. –ö–æ–≥–¥–∞ –°–ï–†–í–ï–† –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É
        socket.on('sync_action', (data) => {
            isRemoteUpdate = true; // –°—Ç–∞–≤–∏–º –±–ª–æ–∫
            
            // –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –±–æ–ª—å—à–µ 1 —Å–µ–∫ - –ø–æ–¥–≥–æ–Ω—è–µ–º
            if (Math.abs(player.getCurrentTime() - data.time) > 1) {
                player.seekTo(data.time);
            }

            if (data.type === 'play') player.playVideo();
            if (data.type === 'pause') player.pauseVideo();

            setTimeout(() => { isRemoteUpdate = false; }, 500); // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫
        });

        // 4. –†–µ–∞–∫—Ü–∏—è
        function sendReaction() {
            socket.emit('send_reaction');
        }
        socket.on('show_reaction', () => {
            const el = document.getElementById('reaction');
            el.classList.add('show-fire');
            setTimeout(() => { 
                el.classList.remove('show-fire'); 
            }, 1500);
        });
    </script>
</body>
</html>
