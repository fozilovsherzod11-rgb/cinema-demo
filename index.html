<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titan Cinema</title>
    <style>
        /* –û—á–∏—Å—Ç–∫–∞ –∏ –ë–∞–∑–∞ */
        * { box-sizing: border-box; }
        body { margin: 0; background-color: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* 1. –ë–ª–æ–∫ –í–ò–î–ï–û (–í–µ—Ä—Ö) */
        #video-section { width: 100%; background: #000; flex-shrink: 0; position: relative; }
        /* –î–µ–ª–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ 16:9 */
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* 2. –ë–ª–æ–∫ –£–ü–†–ê–í–õ–ï–ù–ò–Ø (–°–µ—Ä–µ–¥–∏–Ω–∞) */
        #controls-section { padding: 10px; background: #111; border-bottom: 1px solid #333; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; }
        
        .control-row { display: flex; gap: 8px; }
        
        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∏ */
        input { background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; font-size: 14px; outline: none; flex-grow: 1; }
        input:focus { border-color: #e50914; background: #000; }

        button { padding: 10px 15px; font-size: 14px; font-weight: bold; color: white; background: #333; border: 1px solid #444; border-radius: 6px; cursor: pointer; white-space: nowrap; }
        button.red { background: #e50914; border-color: #e50914; width: 100%; }
        button:active { transform: scale(0.96); }

        /* 3. –ë–ª–æ–∫ –ß–ê–¢ (–ù–∏–∑ - –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ) */
        #chat-section { flex-grow: 1; display: flex; flex-direction: column; background: #0d0d0d; overflow: hidden; position: relative; }
        
        #messages-list { flex-grow: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; display: flex; flex-direction: column; gap: 8px; }
        
        .msg { padding: 8px 12px; background: #222; border-radius: 12px; font-size: 14px; max-width: 85%; line-height: 1.4; word-wrap: break-word; align-self: flex-start; }
        .msg.my { background: #e50914; align-self: flex-end; color: white; }
        .msg.system { background: transparent; color: #666; font-size: 12px; align-self: center; text-align: center; }

        .chat-input-bar { padding: 10px; background: #111; display: flex; gap: 8px; border-top: 1px solid #333; }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–≥–Ω—è */
        .emoji-overlay { position: fixed; bottom: 80px; right: 20px; font-size: 80px; pointer-events: none; opacity: 0; transition: transform 0.6s ease-out, opacity 0.6s; z-index: 999; }
        .fly-up { transform: translateY(-150px); opacity: 1; }

    </style>
</head>
<body>

    <div id="video-section">
        <div class="video-wrapper">
            <div id="player"></div>
        </div>
    </div>

    <div id="controls-section">
        <button class="red" onclick="sendReaction()">üî• –†–ï–°–ü–ï–ö–¢</button>
        
        <div class="control-row">
            <input type="text" id="videoUrlInput" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube..." />
            <button onclick="changeVideo()">‚ñ∂ Load</button>
        </div>
    </div>

    <div id="chat-section">
        <ul id="messages-list">
            <li class="msg system">–ß–∞—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω. –ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å!</li>
        </ul>
        <div class="chat-input-bar">
            <input type="text" id="chatMsgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button class="red" style="width: auto;" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <div id="fireEmoji" class="emoji-overlay">üî•</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let player;
        let isRemoteUpdate = false;

        // --- YOUTUBE SETUP ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk', // –í–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                playerVars: { 'playsinline': 1, 'rel': 0, 'modestbranding': 1, 'controls': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (isRemoteUpdate) return;
            const time = player.getCurrentTime();
            if (event.data === YT.PlayerState.PLAYING) socket.emit('sync_action', { type: 'play', time: time });
            if (event.data === YT.PlayerState.PAUSED) socket.emit('sync_action', { type: 'pause', time: time });
        }

        // --- SOCKET LOGIC ---
        
        // 1. –°–ò–ù–•–†–û–ù
        socket.on('sync_action', (data) => {
            isRemoteUpdate = true;
            if (Math.abs(player.getCurrentTime() - data.time) > 1) player.seekTo(data.time);
            if (data.type === 'play') player.playVideo();
            if (data.type === 'pause') player.pauseVideo();
            setTimeout(() => { isRemoteUpdate = false; }, 500);
        });

        // 2. –†–ï–ê–ö–¶–ò–Ø
        function sendReaction() { socket.emit('send_reaction'); }
        socket.on('show_reaction', () => {
            const el = document.getElementById('fireEmoji');
            el.classList.add('fly-up');
            setTimeout(() => { el.classList.remove('fly-up'); }, 1000);
        });

        // 3. –°–ú–ï–ù–ê –í–ò–î–ï–û
        function changeVideo() {
            const input = document.getElementById('videoUrlInput');
            const url = input.value.trim();
            if (!url) return;

            let videoId = '';
            // –£–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫ (–æ–±—ã—á–Ω–∞—è, –º–æ–±–∏–ª—å–Ω–∞—è, shorts)
            try {
                if (url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
                else if (url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split('?')[0];
                else if (url.includes('shorts/')) videoId = url.split('shorts/')[1].split('?')[0];
            } catch (e) { console.log('Error parsing URL'); }

            if (videoId) {
                socket.emit('change_video', videoId);
                input.value = '';
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ YouTube!');
            }
        }
        
        socket.on('update_video', (videoId) => {
            if(player) player.loadVideoById(videoId);
        });

        // 4. –ß–ê–¢
        const chatInput = document.getElementById('chatMsgInput');
        const messagesList = document.getElementById('messages-list');

        function sendMessage() {
            const txt = chatInput.value.trim();
            if (txt) {
                socket.emit('chat_message', txt);
                chatInput.value = '';
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        chatInput.addEventListener("keyup", function(event) {
            if (event.key === "Enter") sendMessage();
        });

        socket.on('chat_message', (msg) => {
            const li = document.createElement('li');
            li.textContent = msg;
            li.className = 'msg';
            
            // –ï—Å–ª–∏ —ç—Ç–æ –º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞) - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É ID –ø–æ–∑–∂–µ
            // –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –≤—Å–µ —Å–µ—Ä—ã–µ, –∫—Ä–æ–º–µ –º–æ–∏—Ö (–Ω–æ —Ç—É—Ç –º—ã –Ω–µ –∑–Ω–∞–µ–º –∫—Ç–æ "—è")
            // –°–¥–µ–ª–∞–µ–º –ø—Ä–æ—Å—Ç–æ: –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–ª–µ–≤–∞
            
            messagesList.appendChild(li);
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            messagesList.scrollTop = messagesList.scrollHeight;
        });

    </script>
</body>
</html>
