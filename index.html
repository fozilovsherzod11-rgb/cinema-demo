<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titan Cinema</title>
    <style>
        /* –ì–õ–ê–í–ù–´–ô –§–ò–ö–°: 100dvh (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞) */
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            background-color: #000; 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
            height: 100vh; /* –î–ª—è —Å—Ç–∞—Ä—ã—Ö */
            height: 100dvh; /* –î–ª—è –Ω–æ–≤—ã—Ö –º–æ–±–∏–ª–æ–∫ - —á—Ç–æ–±—ã –Ω–µ –ø—Ä—ã–≥–∞–ª–æ */
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤—Å–µ–≥–æ —Å–∞–π—Ç–∞ */
        }

        /* –ó–û–ù–ê 1: –í–ò–î–ï–û (–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ —Å–≤–µ—Ä—Ö—É) */
        #video-section {
            width: 100%;
            background: #000;
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å */
            position: relative;
            z-index: 10;
        }
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            width: 100%;
        }
        .video-wrapper iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* –ó–û–ù–ê 2: –ö–ù–û–ü–ö–ò (–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ) */
        #controls-section {
            padding: 8px 10px;
            background: #111;
            border-bottom: 1px solid #333;
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-row { display: flex; gap: 8px; }
        
        input { 
            background: #222; border: 1px solid #444; color: white; 
            padding: 10px; border-radius: 6px; font-size: 16px; outline: none; flex-grow: 1; 
        }
        
        button { 
            padding: 10px 15px; font-size: 14px; font-weight: bold; 
            color: white; background: #333; border: 1px solid #444; border-radius: 6px; 
        }
        button.red { background: #e50914; border-color: #e50914; width: 100%; }
        
        /* –ó–û–ù–ê 3: –ß–ê–¢ (–†–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ) */
        #chat-section {
            flex-grow: 1; /* –ó–∞–±–∏—Ä–∞–µ—Ç –≤—Å—ë —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ —Å–Ω–∏–∑—É */
            display: flex;
            flex-direction: column;
            background: #0d0d0d;
            overflow: hidden; /* –°–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞ */
            position: relative;
        }
        
        #messages-list {
            flex-grow: 1;
            overflow-y: auto; /* –°–∫—Ä–æ–ª–ª –∑–¥–µ—Å—å */
            padding: 10px;
            list-style: none;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ iPhone */
        }
        
        .msg { padding: 8px 12px; background: #222; border-radius: 12px; font-size: 14px; max-width: 85%; word-wrap: break-word; align-self: flex-start; }
        .msg.system { background: transparent; color: #666; font-size: 12px; align-self: center; }

        .chat-input-bar {
            padding: 10px;
            background: #111;
            border-top: 1px solid #333;
            display: flex; gap: 8px;
            padding-bottom: env(safe-area-inset-bottom); /* –î–ª—è iPhone –±–µ–∑ –∫–Ω–æ–ø–æ–∫ */
        }

        /* –û–≥–æ–Ω—å */
        .emoji-overlay { position: fixed; bottom: 80px; right: 20px; font-size: 80px; pointer-events: none; opacity: 0; transition: transform 0.6s, opacity 0.6s; z-index: 999; }
        .fly-up { transform: translateY(-150px); opacity: 1; }
    </style>
</head>
<body>

    <div id="video-section">
        <div class="video-wrapper">
            <div id="player"></div>
        </div>
    </div>

    <div id="controls-section">
        <button class="red" onclick="sendReaction()">üî• –†–ï–°–ü–ï–ö–¢ (Sync)</button>
        <div class="control-row">
            <input type="text" id="videoUrlInput" placeholder="–°—Å—ã–ª–∫–∞ YouTube..." />
            <button onclick="changeVideo()">‚ñ∂ Load</button>
        </div>
    </div>

    <div id="chat-section">
        <ul id="messages-list">
            <li class="msg system">–ß–∞—Ç –≥–æ—Ç–æ–≤.</li>
        </ul>
        <div class="chat-input-bar">
            <input type="text" id="chatMsgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button class="red" style="width: auto;" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <div id="fireEmoji" class="emoji-overlay">üî•</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let player;
        let isRemoteUpdate = false;

        // --- YOUTUBE ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk',
                playerVars: { 'playsinline': 1, 'rel': 0, 'modestbranding': 1, 'controls': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (isRemoteUpdate) return;
            const time = player.getCurrentTime();
            if (event.data === YT.PlayerState.PLAYING) socket.emit('sync_action', { type: 'play', time: time });
            if (event.data === YT.PlayerState.PAUSED) socket.emit('sync_action', { type: 'pause', time: time });
        }

        // --- –õ–û–ì–ò–ö–ê ---
        socket.on('sync_action', (data) => {
            isRemoteUpdate = true;
            if (Math.abs(player.getCurrentTime() - data.time) > 1) player.seekTo(data.time);
            if (data.type === 'play') player.playVideo();
            if (data.type === 'pause') player.pauseVideo();
            setTimeout(() => { isRemoteUpdate = false; }, 500);
        });

        function sendReaction() { socket.emit('send_reaction'); }
        socket.on('show_reaction', () => {
            const el = document.getElementById('fireEmoji');
            el.classList.add('fly-up');
            setTimeout(() => { el.classList.remove('fly-up'); }, 1000);
        });

        function changeVideo() {
            const input = document.getElementById('videoUrlInput');
            const url = input.value.trim();
            if (!url) return;
            let videoId = '';
            try {
                if (url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
                else if (url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split('?')[0];
                else if (url.includes('shorts/')) videoId = url.split('shorts/')[1].split('?')[0];
            } catch(e) {}

            if (videoId) { socket.emit('change_video', videoId); input.value = ''; }
        }
        socket.on('update_video', (id) => { if(player) player.loadVideoById(id); });

        // –ß–ê–¢
        const chatInput = document.getElementById('chatMsgInput');
        const list = document.getElementById('messages-list');
        
        function sendMessage() {
            const txt = chatInput.value.trim();
            if (txt) { socket.emit('chat_message', txt); chatInput.value = ''; }
        }
        chatInput.addEventListener("keyup", (e) => { if(e.key === "Enter") sendMessage(); });

        socket.on('chat_message', (msg) => {
            const li = document.createElement('li');
            li.className = 'msg';
            li.textContent = msg;
            list.appendChild(li);
            list.scrollTop = list.scrollHeight;
        });
    </script>
</body>
</html>
