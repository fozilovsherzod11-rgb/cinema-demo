<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Private Lounge</title>
    <style>
        /* --- –ë–ê–ó–ê --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #000; color: #fff; font-family: -apple-system, sans-serif;
            height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- 1. –®–ê–ü–ö–ê (–ë–ò–¢–ö–û–ò–ù) --- */
        header {
            padding: 10px 15px; background: #0a0a0a; border-bottom: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .app-name { font-weight: bold; font-size: 14px; color: #666; letter-spacing: 1px; }
        
        /* –¢–∏–∫–µ—Ä */
        .btc-ticker { font-family: monospace; font-size: 14px; display: flex; align-items: center; gap: 6px; }
        .btc-price { font-weight: bold; transition: color 0.3s; }
        .up { color: #0f0; } .down { color: #f04; }
        .btc-icon { color: #f2a900; }

        /* --- 2. –í–ò–î–ï–û --- */
        #video-area {
            width: 100%; aspect-ratio: 16/9; background: #000;
            flex-shrink: 0; position: relative; z-index: 10;
        }
        #player { width: 100%; height: 100%; position: absolute; }

        /* --- 3. –£–ü–†–ê–í–õ–ï–ù–ò–ï --- */
        #controls {
            padding: 8px; background: #111; border-bottom: 1px solid #222;
            display: flex; gap: 8px; flex-shrink: 0; z-index: 20;
        }
        input.dark { background: #222; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px; flex-grow: 1; font-size: 14px; }
        button { padding: 0 15px; background: #333; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button.red { background: #e50914; }

        /* --- 4. –°–ï–¢–ö–ê (–û–¢–î–ï–õ–¨–ù–´–ï –û–ö–ù–ê) --- */
        #user-grid {
            flex-grow: 1; 
            background: #050505;
            padding: 5px;
            display: grid;
            gap: 5px;
            grid-template-columns: 1fr 1fr; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 2 –æ–∫–Ω–∞ —Ä—è–¥–æ–º */
            grid-auto-rows: 1fr; 
            overflow-y: auto;
        }

        /* –ü–ª–∏—Ç–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ */
        .user-card {
            background: #111; border: 1px solid #333; border-radius: 8px;
            position: relative; display: flex; flex-direction: column; justify-content: flex-end;
            overflow: hidden; min-height: 100px;
        }
        
        .user-label {
            position: absolute; top: 6px; left: 6px;
            background: rgba(0,0,0,0.5); padding: 3px 6px; border-radius: 4px;
            font-size: 11px; color: #888; font-weight: bold; text-transform: uppercase;
        }

        .bubbles-container {
            padding: 10px; display: flex; flex-direction: column; gap: 6px;
            max-height: 100%; overflow: hidden;
        }

        .bubble {
            background: #fff; color: #000; padding: 8px 12px;
            border-radius: 10px; border-bottom-left-radius: 2px;
            font-size: 14px; align-self: flex-start;
            animation: pop 0.2s ease-out; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            word-wrap: break-word;
        }
        @keyframes pop { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }

        /* --- 5. –í–í–û–î –°–û–û–ë–©–ï–ù–ò–Ø --- */
        #input-bar {
            padding: 10px; background: #111; border-top: 1px solid #222;
            display: flex; gap: 10px; flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom, 10px);
        }

        /* --- 6. –í–•–û–î (–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π) --- */
        #login-overlay {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box { text-align: center; width: 80%; max-width: 300px; }
        .login-box h2 { margin-bottom: 20px; font-weight: normal; color: #888; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å</h2>
            <input type="text" id="nameIn" class="dark" placeholder="–í–∞—à–µ –∏–º—è..." style="width: 100%; margin-bottom: 15px;">
            <button class="red" style="width: 100%; padding: 12px;" onclick="enterRoom()">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <header>
        <div class="btc-ticker">
            <span class="btc-icon">‚Çø</span>
            <span id="btc-price">...</span>
        </div>
        <div class="app-name">PRIVATE LOUNGE</div>
    </header>

    <div id="video-area">
        <div id="player"></div>
    </div>

    <div id="controls">
        <button class="red" onclick="socket.emit('send_reaction')">üî•</button>
        <input type="text" id="vidUrl" class="dark" placeholder="–°—Å—ã–ª–∫–∞ (Shorts/Video)...">
        <button onclick="changeVideo()">‚ñ∂</button>
    </div>

    <div id="user-grid"></div>

    <div id="input-bar">
        <input type="text" id="msgIn" class="dark" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button class="red" onclick="sendMsg()">‚û§</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let player;

        // --- –ë–ò–¢–ö–û–ò–ù (Websocket Binance) ---
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
        const btcEl = document.getElementById('btc-price');
        let lastP = 0;
        ws.onmessage = (e) => {
            const p = parseFloat(JSON.parse(e.data).p).toFixed(2);
            btcEl.textContent = p;
            btcEl.className = p > lastP ? 'btc-price up' : 'btc-price down';
            lastP = p;
        };

        // --- –í–•–û–î ---
        function enterRoom() {
            const name = document.getElementById('nameIn').value.trim();
            if(name) {
                socket.emit('join_game', name); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è
                document.getElementById('login-overlay').style.display = 'none';
                
                // –ì—Ä—É–∑–∏–º —é—Ç—É–±
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                document.body.appendChild(tag);
            }
        }

        // --- –°–ï–¢–ö–ê ---
        socket.on('update_grid', (users) => {
            const grid = document.getElementById('user-grid');
            grid.innerHTML = ''; // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
            
            // –ê–¥–∞–ø—Ç–∏–≤ –∫–æ–ª–æ–Ω–æ–∫
            let cols = (users.length === 1) ? 1 : 2; 
            if(window.innerWidth > 600 && users.length > 4) cols = 3;
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            users.forEach(u => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.style.borderColor = u.color; // –¶–≤–µ—Ç —Ä–∞–º–∫–∏
                
                card.innerHTML = `
                    <div class="user-label" style="color:${u.color}">${u.name}</div>
                    <div class="bubbles-container" id="chat-${u.id}"></div>
                `;
                grid.appendChild(card);
            });
        });

        socket.on('chat_bubble', (data) => {
            const area = document.getElementById(`chat-${data.userId}`);
            if(area) {
                const b = document.createElement('div');
                b.className = 'bubble';
                b.textContent = data.text;
                area.appendChild(b);
                // –î–µ—Ä–∂–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏–≤–∞—Ç—å –ø–ª–∏—Ç–∫—É
                while(area.children.length > 3) area.removeChild(area.firstChild);
            }
        });

        // --- –í–ò–î–ï–û ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk',
                playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0 },
                events: { 'onStateChange': onStateChange }
            });
        }
        function onStateChange(e) {
            if (e.data == 1) socket.emit('sync_action', {type:'play', time:player.getCurrentTime()});
            if (e.data == 2) socket.emit('sync_action', {type:'pause', time:player.getCurrentTime()});
        }
        socket.on('sync_action', (d) => { if(Math.abs(player.getCurrentTime()-d.time)>1) player.seekTo(d.time); d.type=='play'?player.playVideo():player.pauseVideo(); });
        socket.on('update_video', (id) => player && player.loadVideoById(id));

        function changeVideo() {
            let val = document.getElementById('vidUrl').value;
            let vid = '';
            if(val.includes('shorts/')) vid = val.split('shorts/')[1].split('?')[0];
            else if(val.includes('v=')) vid = val.split('v=')[1].split('&')[0];
            else if(val.includes('youtu.be/')) vid = val.split('youtu.be/')[1].split('?')[0];
            else if(val.length===11) vid = val;
            
            if(vid) { socket.emit('change_video', vid); document.getElementById('vidUrl').value=''; }
        }

        // –ß–ê–¢ –û–¢–ü–†–ê–í–ö–ê
        function sendMsg() {
            const txt = document.getElementById('msgIn').value.trim();
            if(txt) { socket.emit('chat_message', txt); document.getElementById('msgIn').value=''; }
        }
    </script>
</body>
</html>
